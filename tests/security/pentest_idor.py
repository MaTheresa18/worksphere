#!/usr/bin/env python3
"""
IDOR / Authorization Pentest
Tests for Insecure Direct Object Reference and broken access control vulnerabilities.
Enhanced version with dynamic token fetching and comprehensive tests.
"""

import requests
import sys

BASE_URL = "http://localhost:8000/api"

# Test credentials
ADMIN_EMAIL = "admin@example.com"
ADMIN_PASSWORD = "password"
USER_EMAIL = "member@example.com"
USER_PASSWORD = "password"


def get_auth_token(email, password):
    """Authenticate and get bearer token."""
    try:
        response = requests.post(
            f"{BASE_URL}/login",
            json={"email": email, "password": password},
            headers={"Accept": "application/json", "Content-Type": "application/json"}
        )
        if response.status_code == 200:
            data = response.json()
            return data.get("token") or data.get("access_token")
        elif response.status_code == 429:
            print(f"‚ö†Ô∏è  Rate limited on login for {email}")
            return None
        else:
            print(f"‚ö†Ô∏è  Login failed for {email}: {response.status_code}")
            return None
    except Exception as e:
        print(f"‚ö†Ô∏è  Login error for {email}: {e}")
        return None


def get_user_info(token):
    """Get current user info."""
    try:
        response = requests.get(
            f"{BASE_URL}/user",
            headers={"Authorization": f"Bearer {token}", "Accept": "application/json"}
        )
        if response.status_code == 200:
            return response.json()
        return None
    except:
        return None


def run_idor_tests():
    """Run comprehensive IDOR and authorization tests."""
    print("=" * 60)
    print(" IDOR / Authorization Security Tests")
    print("=" * 60)
    
    all_passed = True
    
    # Get tokens dynamically
    print("\n--- Authenticating Test Users ---")
    admin_token = get_auth_token(ADMIN_EMAIL, ADMIN_PASSWORD)
    user_token = get_auth_token(USER_EMAIL, USER_PASSWORD)
    
    if not admin_token:
        print("‚ùå Could not get admin token. Using fallback tests.")
    else:
        print(f"‚úÖ Admin authenticated")
        
    if not user_token:
        print("‚ùå Could not get user token. Skipping user-level tests.")
        return False
    else:
        print(f"‚úÖ User authenticated")
    
    # Get user IDs
    user_info = get_user_info(user_token)
    admin_info = get_auth_token and get_user_info(admin_token)
    
    user_id = user_info.get("public_id") or user_info.get("id") if user_info else None
    admin_id = admin_info.get("public_id") or admin_info.get("id") if admin_info else "00000000-0000-0000-0000-000000000000"
    
    print(f"\n--- User IDs ---")
    print(f"  Admin: {admin_id[:20]}..." if admin_id else "  Admin: Not found")
    print(f"  User:  {user_id[:20]}..." if user_id else "  User: Not found")
    
    headers_user = {
        "Authorization": f"Bearer {user_token}",
        "Accept": "application/json",
        "Content-Type": "application/json"
    }
    
    # Test definitions
    tests = []
    
    # 1. Admin-only resource access tests
    tests.extend([
        {"name": "List All Users (Admin Only)", "url": f"{BASE_URL}/users", "method": "GET", "expected": [403, 401]},
        {"name": "List All Teams (Admin Only)", "url": f"{BASE_URL}/teams", "method": "GET", "expected": [403, 401]},
        {"name": "List Audit Logs (Admin Only)", "url": f"{BASE_URL}/audit-logs", "method": "GET", "expected": [403, 401]},
        {"name": "List All Roles (Admin Only)", "url": f"{BASE_URL}/roles", "method": "GET", "expected": [403, 401]},
        {"name": "System Settings (Admin Only)", "url": f"{BASE_URL}/settings", "method": "GET", "expected": [403, 401]},
        {"name": "Blocked IPs (Admin Only)", "url": f"{BASE_URL}/blocked-ips", "method": "GET", "expected": [403, 401]},
    ])
    
    # 2. IDOR tests - accessing another user's data
    if admin_id:
        tests.extend([
            {"name": "View Other User (IDOR)", "url": f"{BASE_URL}/users/{admin_id}", "method": "GET", "expected": [403, 404]},
            {"name": "Update Other User (IDOR)", "url": f"{BASE_URL}/users/{admin_id}", "method": "PUT", "data": {"name": "Hacked"}, "expected": [403, 404, 405]},
            {"name": "Delete Other User (IDOR)", "url": f"{BASE_URL}/users/{admin_id}", "method": "DELETE", "expected": [403, 404, 405]},
        ])
    
    # 3. Ticket/Task IDOR tests
    tests.extend([
        {"name": "Access Non-existent Ticket", "url": f"{BASE_URL}/tickets/99999", "method": "GET", "expected": [403, 404]},
        {"name": "Access Non-existent Task", "url": f"{BASE_URL}/tasks/99999", "method": "GET", "expected": [403, 404]},
        {"name": "Access Non-existent Project", "url": f"{BASE_URL}/projects/99999", "method": "GET", "expected": [403, 404]},
    ])
    
    # 4. Parameter manipulation tests
    tests.extend([
        {"name": "Escalate Role via PUT", "url": f"{BASE_URL}/user/profile", "method": "PUT", "data": {"role": "administrator"}, "expected": [200, 422]},
        {"name": "Add Admin Permission", "url": f"{BASE_URL}/user/profile", "method": "PUT", "data": {"permissions": ["*"]}, "expected": [200, 422]},
    ])
    
    print("\n--- Running IDOR Tests ---")
    
    for test in tests:
        try:
            if test["method"] == "GET":
                response = requests.get(test["url"], headers=headers_user, timeout=10)
            elif test["method"] == "PUT":
                response = requests.put(test["url"], headers=headers_user, json=test.get("data", {}), timeout=10)
            elif test["method"] == "DELETE":
                response = requests.delete(test["url"], headers=headers_user, timeout=10)
            elif test["method"] == "POST":
                response = requests.post(test["url"], headers=headers_user, json=test.get("data", {}), timeout=10)
            else:
                continue
            
            status = response.status_code
            expected = test["expected"] if isinstance(test["expected"], list) else [test["expected"]]
            
            if status in expected:
                print(f"‚úÖ PASSED: {test['name']} - Got {status}")
            elif status == 429:
                print(f"‚è∏Ô∏è  RATE LIMITED: {test['name']} - Skipped")
            else:
                print(f"‚ùå FAILED: {test['name']} - Expected {expected}, Got {status}")
                if status == 200:
                    # This is a security issue - unauthorized access succeeded
                    try:
                        data = response.json()
                        print(f"   ‚ö†Ô∏è  Leaked data: {str(data)[:100]}...")
                    except:
                        pass
                all_passed = False
                
        except requests.exceptions.Timeout:
            print(f"‚è∞ TIMEOUT: {test['name']}")
        except Exception as e:
            print(f"üí• ERROR: {test['name']} - {e}")
            all_passed = False
    
    # 5. Verify user cannot elevate own privileges
    print("\n--- Privilege Escalation Check ---")
    try:
        user_after = get_user_info(user_token)
        if user_after:
            role = user_after.get("role", user_after.get("roles", "unknown"))
            if isinstance(role, list):
                role = role[0] if role else "unknown"
            if role and "admin" in str(role).lower():
                print(f"‚ùå CRITICAL: User role was escalated to: {role}")
                all_passed = False
            else:
                print(f"‚úÖ User role unchanged: {role}")
    except Exception as e:
        print(f"‚ö†Ô∏è  Could not verify role: {e}")
    
    print("\n" + "=" * 60)
    if all_passed:
        print("‚úÖ All IDOR/Authorization Tests Passed!")
    else:
        print("‚ö†Ô∏è  Some Security Tests Failed!")
    print("=" * 60)
    
    return all_passed


if __name__ == "__main__":
    success = run_idor_tests()
    sys.exit(0 if success else 1)
