#!/usr/bin/env python3
"""
Path Traversal / LFI Pentest
Tests for directory traversal and local file inclusion vulnerabilities.
"""

import requests
import sys
import urllib.parse

BASE_URL = "http://localhost:8000/api"

# Test credentials
USER_EMAIL = "member@example.com"
USER_PASSWORD = "password"

# Path traversal payloads
PATH_TRAVERSAL_PAYLOADS = [
    # Basic traversal
    "../../../etc/passwd",
    "..\\..\\..\\etc\\passwd",
    "....//....//....//etc/passwd",
    "..%2F..%2F..%2Fetc%2Fpasswd",
    "..%252F..%252F..%252Fetc%252Fpasswd",  # Double encoding
    
    # Null byte injection (legacy)
    "../../../etc/passwd%00",
    "../../../etc/passwd%00.jpg",
    "../../../etc/passwd\x00.jpg",
    
    # Unicode encoding
    "..%c0%af..%c0%af..%c0%afetc/passwd",
    "..%ef%bc%8f..%ef%bc%8f..%ef%bc%8fetc/passwd",
    
    # Windows paths
    "..\\..\\..\\windows\\system32\\config\\sam",
    "....\\\\....\\\\....\\\\windows\\system32\\config\\sam",
    
    # Absolute paths
    "/etc/passwd",
    "/etc/shadow",
    "/proc/self/environ",
    "/var/log/apache2/access.log",
    "C:\\Windows\\System32\\drivers\\etc\\hosts",
    
    # Laravel specific
    "../../../.env",
    "....//....//....//storage/logs/laravel.log",
    "..\\..\\..\\storage\\app\\private\\",
    "../../../config/app.php",
    "../../../vendor/autoload.php",
    
    # Wrapper injection (PHP)
    "php://filter/convert.base64-encode/resource=../../../.env",
    "php://input",
    "data://text/plain;base64,PD9waHAgcGhwaW5mbygpOyA/Pg==",
    "expect://id",
]


def get_auth_token(email, password):
    """Authenticate and get bearer token."""
    try:
        response = requests.post(
            f"{BASE_URL}/login",
            json={"email": email, "password": password},
            headers={"Accept": "application/json", "Content-Type": "application/json"}
        )
        if response.status_code == 200:
            data = response.json()
            return data.get("token") or data.get("access_token")
        return None
    except:
        return None


def test_path_traversal(url, payload, headers, param_name=None):
    """Test a single path traversal payload."""
    try:
        if param_name:
            response = requests.get(url, params={param_name: payload}, headers=headers, timeout=5)
        else:
            response = requests.get(f"{url}/{urllib.parse.quote(payload, safe='')}", headers=headers, timeout=5)
        
        return response.status_code, response.text[:1000]
    except Exception as e:
        return "ERROR", str(e)[:100]


def check_sensitive_content(response_text):
    """Check if response contains sensitive file content."""
    indicators = [
        "root:x:0:0:",  # /etc/passwd
        "root:$",  # /etc/shadow
        "APP_KEY=",  # .env
        "DB_PASSWORD=",  # .env
        "[boot loader]",  # Windows boot.ini
        "# User Database",  # /etc/passwd comment
        "localhost",  # hosts file
        "<?php",  # PHP source code
        "AWS_SECRET",
        "MAIL_PASSWORD",
        "REDIS_PASSWORD",
    ]
    
    for indicator in indicators:
        if indicator in response_text:
            return True, indicator
    return False, None


def run_path_traversal_tests():
    """Run path traversal security tests."""
    print("=" * 60)
    print(" Path Traversal / LFI Tests")
    print("=" * 60)
    
    all_passed = True
    
    # Authenticate
    print("\n--- Authenticating ---")
    token = get_auth_token(USER_EMAIL, USER_PASSWORD)
    
    if not token:
        print("⚠️  Could not authenticate. Running unauthenticated tests only.")
        headers = {"Accept": "application/json"}
    else:
        print("✅ Authenticated")
        headers = {
            "Authorization": f"Bearer {token}",
            "Accept": "application/json"
        }
    
    # Endpoints that handle file paths
    file_endpoints = [
        {"name": "Attachment Download", "url": f"{BASE_URL}/attachments", "param": "path"},
        {"name": "File Export", "url": f"{BASE_URL}/exports", "param": "file"},
        {"name": "Template Preview", "url": f"{BASE_URL}/templates", "param": "template"},
        {"name": "Avatar Fetch", "url": f"{BASE_URL}/avatars", "param": "path"},
        {"name": "Document View", "url": f"{BASE_URL}/documents", "param": "file"},
        {"name": "Report Download", "url": f"{BASE_URL}/reports/download", "param": "name"},
    ]
    
    print("\n--- Testing File Path Parameters ---")
    
    # Test critical payloads
    critical_payloads = [
        "../../../.env",
        "../../../etc/passwd",
        "....//....//....//storage/logs/laravel.log",
        "/etc/passwd",
        "php://filter/convert.base64-encode/resource=../../../.env",
    ]
    
    for endpoint in file_endpoints:
        print(f"\n  Testing: {endpoint['name']}")
        vulnerable = False
        
        for payload in critical_payloads:
            status, response = test_path_traversal(
                endpoint["url"],
                payload,
                headers,
                endpoint.get("param")
            )
            
            if status == 429:
                print(f"    ⏸️  Rate limited")
                break
            elif status in [200, 201]:
                is_sensitive, indicator = check_sensitive_content(response)
                if is_sensitive:
                    print(f"    ❌ VULNERABLE: {payload[:40]}...")
                    print(f"       Found: {indicator}")
                    vulnerable = True
                    all_passed = False
                else:
                    print(f"    ✓  {payload[:30]}... - Status {status} (no sensitive data)")
            elif status in [400, 403, 422]:
                print(f"    ✓  {payload[:30]}... - Blocked ({status})")
            elif status in [404, 405]:
                print(f"    ⏭️  Endpoint not found")
                break
            elif status == "ERROR":
                print(f"    ⚠️  Error: {response[:50]}")
        
        if not vulnerable:
            print(f"    ✅ No path traversal detected")
    
    # Direct file access tests
    print("\n--- Direct File Access Tests ---")
    
    direct_paths = [
        ("/.env", "Environment file"),
        ("/storage/logs/laravel.log", "Laravel log"),
        ("/.git/config", "Git config"),
        ("/config/app.php", "App config"),
        ("/vendor/autoload.php", "Composer autoload"),
        ("/.htaccess", "Apache config"),
        ("/web.config", "IIS config"),
    ]
    
    # Test on web root (not API)
    web_base = BASE_URL.replace("/api", "")
    
    for path, name in direct_paths:
        try:
            response = requests.get(f"{web_base}{path}", headers={"Accept": "*/*"}, timeout=5)
            
            if response.status_code == 200:
                is_sensitive, indicator = check_sensitive_content(response.text)
                if is_sensitive:
                    print(f"  ❌ EXPOSED: {name} ({path})")
                    print(f"     Contains: {indicator}")
                    all_passed = False
                elif len(response.text) > 100:
                    print(f"  ⚠️  Accessible: {name} ({path}) - Review content")
                else:
                    print(f"  ✅ {name}: 200 but no sensitive content")
            else:
                print(f"  ✅ {name}: {response.status_code}")
        except:
            print(f"  ✅ {name}: Not accessible")
    
    print("\n" + "=" * 60)
    if all_passed:
        print("✅ All Path Traversal Tests Passed!")
    else:
        print("⚠️  Path Traversal Vulnerabilities Detected!")
    print("=" * 60)
    
    return all_passed


if __name__ == "__main__":
    success = run_path_traversal_tests()
    sys.exit(0 if success else 1)
