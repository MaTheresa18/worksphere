#!/usr/bin/env python3
"""
SSRF (Server-Side Request Forgery) Pentest
Tests for SSRF vulnerabilities in URL input fields, webhooks, and callbacks.
"""

import requests
import sys

BASE_URL = "http://localhost:8000/api"

# Test credentials
USER_EMAIL = "member@example.com"
USER_PASSWORD = "password"

# SSRF payloads targeting internal resources
SSRF_PAYLOADS = [
    # Cloud metadata endpoints
    "http://169.254.169.254/latest/meta-data/",
    "http://169.254.169.254/latest/user-data/",
    "http://metadata.google.internal/computeMetadata/v1/",
    "http://100.100.100.200/latest/meta-data/",  # Alibaba
    
    # Internal network
    "http://127.0.0.1/",
    "http://localhost/",
    "http://0.0.0.0/",
    "http://[::1]/",
    "http://0177.0.0.1/",  # Octal
    "http://0x7f.0.0.1/",  # Hex
    "http://2130706433/",  # Decimal
    
    # Internal hosts
    "http://internal/",
    "http://intranet/",
    "http://localhost:22/",  # SSH
    "http://localhost:3306/",  # MySQL
    "http://localhost:6379/",  # Redis
    "http://localhost:9000/",  # Reverb/WebSocket
    
    # File protocol
    "file:///etc/passwd",
    "file:///etc/shadow",
    "file:///proc/self/environ",
    
    # Bypass attempts
    "http://127.0.0.1:80@evil.com/",
    "http://evil.com#@127.0.0.1/",
    "http://127.0.0.1.evil.com/",
]


def get_auth_token(email, password):
    """Authenticate and get bearer token."""
    try:
        response = requests.post(
            f"{BASE_URL}/login",
            json={"email": email, "password": password},
            headers={"Accept": "application/json", "Content-Type": "application/json"}
        )
        if response.status_code == 200:
            data = response.json()
            return data.get("token") or data.get("access_token")
        return None
    except:
        return None


def test_ssrf_in_field(url, method, field_name, payload, headers, timeout=5):
    """Test a single SSRF payload in a specific field."""
    try:
        data = {field_name: payload}
        
        if method == "POST":
            response = requests.post(url, json=data, headers=headers, timeout=timeout)
        elif method == "PUT":
            response = requests.put(url, json=data, headers=headers, timeout=timeout)
        else:
            response = requests.get(url, params=data, headers=headers, timeout=timeout)
        
        return response.status_code, response.text[:500]
    except requests.exceptions.Timeout:
        return "TIMEOUT", "Request timed out (potential SSRF success)"
    except requests.exceptions.ConnectionError as e:
        return "ERROR", str(e)[:100]
    except Exception as e:
        return "ERROR", str(e)[:100]


def run_ssrf_tests():
    """Run SSRF security tests."""
    print("=" * 60)
    print(" SSRF (Server-Side Request Forgery) Tests")
    print("=" * 60)
    
    all_passed = True
    
    # Authenticate
    print("\n--- Authenticating ---")
    token = get_auth_token(USER_EMAIL, USER_PASSWORD)
    
    if not token:
        print("⚠️  Could not authenticate. Running unauthenticated tests only.")
        headers = {"Accept": "application/json", "Content-Type": "application/json"}
    else:
        print("✅ Authenticated")
        headers = {
            "Authorization": f"Bearer {token}",
            "Accept": "application/json",
            "Content-Type": "application/json"
        }
    
    # Define endpoints that might accept URLs
    url_endpoints = [
        # Avatar/Image URLs
        {"name": "Profile Avatar URL", "url": f"{BASE_URL}/user/profile", "method": "PUT", "field": "avatar_url"},
        {"name": "Profile Website", "url": f"{BASE_URL}/user/profile", "method": "PUT", "field": "website"},
        
        # Webhook/Callback URLs (if exist)
        {"name": "Webhook URL", "url": f"{BASE_URL}/webhooks", "method": "POST", "field": "url"},
        {"name": "Callback URL", "url": f"{BASE_URL}/integrations", "method": "POST", "field": "callback_url"},
        
        # Import/Export URLs
        {"name": "Import URL", "url": f"{BASE_URL}/import", "method": "POST", "field": "source_url"},
        
        # Email configuration
        {"name": "Email Link", "url": f"{BASE_URL}/email-accounts", "method": "POST", "field": "server"},
    ]
    
    print("\n--- Testing URL Fields for SSRF ---")
    
    # Test a subset of payloads on each endpoint
    critical_payloads = [
        "http://169.254.169.254/latest/meta-data/",
        "http://127.0.0.1/",
        "file:///etc/passwd",
        "http://localhost:6379/",
    ]
    
    for endpoint in url_endpoints:
        print(f"\n  Testing: {endpoint['name']}")
        vulnerable = False
        
        for payload in critical_payloads:
            status, response = test_ssrf_in_field(
                endpoint["url"],
                endpoint["method"],
                endpoint["field"],
                payload,
                headers
            )
            
            if status == 429:
                print(f"    ⏸️  Rate limited")
                break
            elif status == "TIMEOUT":
                print(f"    ⚠️  TIMEOUT on {payload[:40]}... - Possible SSRF!")
                vulnerable = True
            elif status in [200, 201]:
                # Check if the response contains internal data
                if any(indicator in response.lower() for indicator in [
                    "root:", "passwd", "ami-", "instance-id", "meta-data",
                    "redis", "mysql", "ssh", "private", "secret"
                ]):
                    print(f"    ❌ VULNERABLE: {payload[:40]}...")
                    print(f"       Response contains sensitive data!")
                    vulnerable = True
                    all_passed = False
                else:
                    print(f"    ✓  {payload[:30]}... - Status {status} (no leak)")
            elif status in [400, 422]:
                print(f"    ✓  {payload[:30]}... - Blocked ({status})")
            elif status in [404, 405]:
                print(f"    ⏭️  Endpoint not found/allowed")
                break
        
        if not vulnerable:
            print(f"    ✅ No SSRF detected")
    
    # Test internal metadata specifically
    print("\n--- Cloud Metadata Access Test ---")
    
    metadata_endpoints = [
        ("AWS", "http://169.254.169.254/latest/meta-data/"),
        ("GCP", "http://metadata.google.internal/computeMetadata/v1/"),
        ("Azure", "http://169.254.169.254/metadata/instance"),
    ]
    
    for cloud, metadata_url in metadata_endpoints:
        try:
            # Try to access directly (should be blocked at network level)
            response = requests.get(metadata_url, timeout=2)
            if response.status_code == 200:
                print(f"  ⚠️  {cloud} metadata directly accessible (network issue)")
            else:
                print(f"  ✅ {cloud} metadata not accessible")
        except:
            print(f"  ✅ {cloud} metadata blocked/unreachable")
    
    print("\n" + "=" * 60)
    if all_passed:
        print("✅ All SSRF Tests Passed!")
    else:
        print("⚠️  Potential SSRF Vulnerabilities Detected!")
    print("=" * 60)
    
    return all_passed


if __name__ == "__main__":
    success = run_ssrf_tests()
    sys.exit(0 if success else 1)
